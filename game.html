<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bingo Game</title>

<style>
body{font-family:Arial;text-align:center}
.grid{display:grid;grid-template-columns:repeat(5,60px);gap:5px;justify-content:center;margin:10px}
.cell{width:60px;height:60px;line-height:60px;border:1px solid #000}
.A{background:#1e90ff;color:white}
.B{background:#2ecc71;color:white}
.win{outline:4px solid gold}
#chat{border:1px solid #ccc;height:120px;overflow:auto;margin:10px;padding:5px}
#bingo{font-size:28px;font-weight:bold;color:red;margin:10px}
</style>
</head>

<body>

<h2 id="title"></h2>
<div id="turn"></div>
<div id="bingo"></div>

<div class="grid" id="board"></div>

<input id="num" type="number" min="1" max="25">
<button onclick="callNum()">Call</button>
<button onclick="reset()">Reset</button>

<h3>Numbers:</h3>
<div id="log"></div>

<h3>Chat</h3>
<div id="chat"></div>
<input id="msg">
<button onclick="send()">Send</button>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getDatabase,ref,push,set,remove,onValue,onChildAdded} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const params=new URLSearchParams(location.search);
const ROOM="rooms/"+params.get("room")+"/";
const ROLE=params.get("role");
const NAME=params.get("name");

title.innerText=(ROLE==="A"?"ðŸ”µ ":"ðŸŸ¢ ")+NAME;

const config={
 apiKey:"AIzaSyCdcOpVzbZwKkbiSTHfsbYIecRuDbq9uns",
 databaseURL:"https://bingo-sgthegreat-default-rtdb.firebaseio.com",
 projectId:"bingo-sgthegreat"
};

const app=initializeApp(config);
const db=getDatabase(app);

const turnRef=ref(db,ROOM+"turn");
const callsRef=ref(db,ROOM+"calls");
const chatRef=ref(db,ROOM+"chat");
const winRef=ref(db,ROOM+"winner");

onValue(turnRef,s=>{ if(!s.exists()) set(turnRef,"A"); });

let called={};
let nums=Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
let grid=[];

nums.forEach((n,i)=>{
 let d=document.createElement("div");
 d.className="cell";
 d.id="c"+n;
 d.innerText=n;
 board.appendChild(d);
 grid[i]=n;
});

const lines=[
[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
[0,6,12,18,24],[4,8,12,16,20]
];

function checkBingo(){
 let score=0;
 lines.forEach(line=>{
  if(line.every(i=>called[grid[i]])){
   score++;
   line.forEach(i=>document.getElementById("c"+grid[i]).classList.add("win"));
  }
 });
 bingo.innerText="BINGO".slice(0,score);
 if(score>=5) set(winRef,ROLE);
}

onValue(winRef,s=>{
 if(!s.exists()) return;
 let winner=s.val();
 if(winner===ROLE){
  bingo.innerText="ðŸŽ‰ BINGO! You Win!";
 }else{
  bingo.innerText="ðŸ˜„ Opponent Wins!";
 }
});

onValue(turnRef,s=>{
 turn.innerText=s.val()===ROLE?"âœ… Your turn":"â³ Opponent turn";
});

window.callNum=function(){
 onValue(turnRef,s=>{
  if(s.val()!==ROLE) return alert("Wait turn");

  let n=num.value;
  if(!n||called[n]) return alert("Invalid");

  called[n]=1;
  push(callsRef,{num:n,by:ROLE});
  set(turnRef,ROLE==="A"?"B":"A");
  num.value="";
  checkBingo();
 },{onlyOnce:true});
};

onChildAdded(callsRef,s=>{
 let {num,by}=s.val();
 called[num]=1;
 log.innerText+=" "+num;
 document.getElementById("c"+num)?.classList.add(by);
 checkBingo();
});

window.send=function(){
 if(!msg.value) return;
 push(chatRef,{name:NAME,text:msg.value});
 msg.value="";
};

onChildAdded(chatRef,s=>{
 let m=s.val();
 chat.innerHTML+=`<div><b>${m.name}:</b> ${m.text}</div>`;
 chat.scrollTop=chat.scrollHeight;
});

window.reset=function(){
 remove(ref(db,ROOM));
 location.reload();
};
</script>

</body>
</html>
